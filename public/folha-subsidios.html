<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Subs√≠dios - SGVA</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="vendor/bootstrap-icons/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="folha-shared.css">
    <style>
        .badge-tipo {
            padding: 0.5em 1em;
            border-radius: 20px;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .subsidio-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            overflow: hidden;
            position: relative;
        }
        .subsidio-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .subsidio-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3) !important;
        }
        .subsidio-card:hover::before {
            opacity: 1;
        }
        .subsidio-card .card-body {
            position: relative;
            z-index: 1;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .subsidio-card .card-body-clickable {
            cursor: pointer;
        }
        .subsidio-card .card-footer {
            position: relative;
            z-index: 2;
            background: transparent;
        }
        .subsidio-card .card-footer button {
            position: relative;
            z-index: 3;
        }
        .subsidio-card.isento {
            border-left: 4px solid #28a745;
        }
        .subsidio-card.tributavel {
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block sidebar p-3">
                <div class="text-white mb-4">
                    <h4><i class="bi bi-cash-stack"></i> SGVA Folha</h4>
                    <small>Sistema Profissional</small>
                </div>

                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-dashboard.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-funcionarios.html">
                            <i class="bi bi-people"></i> Funcion√°rios
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link active" href="folha-subsidios.html">
                            <i class="bi bi-wallet2"></i> Subs√≠dios
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-categorias.html">
                            <i class="bi bi-diagram-3"></i> Categorias
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-calculo.html">
                            <i class="bi bi-calculator"></i> Calcular Folha
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-salarios.html">
                            <i class="bi bi-table"></i> Folha de Sal√°rios
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-irt.html">
                            <i class="bi bi-bar-chart-steps"></i> Escal√µes IRT
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-historico.html">
                            <i class="bi bi-clock-history"></i> Hist√≥rico
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-excel.html">
                            <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-notificacoes.html">
                            <i class="bi bi-bell"></i> Notifica√ß√µes
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-backup.html">
                            <i class="bi bi-hdd"></i> Backup
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="folha-configuracoes.html">
                            <i class="bi bi-gear"></i> Configura√ß√µes
                        </a>
                    </li>
                </ul>
                
                <!-- Bot√£o Voltar ao Painel -->
                <div class="mt-4 pt-3 border-top border-light">
                    <a href="index.html" class="btn btn-outline-light btn-sm w-100">
                        <i class="bi bi-arrow-left"></i> Voltar ao Painel
                    </a>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-4 py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="bi bi-wallet2"></i> Gest√£o de Subs√≠dios</h2>
                        <p class="text-muted">Configure subs√≠dios e atribua a funcion√°rios</p>
                    </div>
                    <button id="btnNovoSubsidio" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalSubsidio">
                        <i class="bi bi-plus-circle"></i> Novo Subs√≠dio
                    </button>
                </div>

                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="filtroNome" placeholder="üîç Buscar subs√≠dio...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filtroTipo">
                                    <option value="">Todos os tipos</option>
                                    <option value="regular">Regular</option>
                                    <option value="especial">Especial</option>
                                    <option value="anual">Anual</option>
                                    <option value="ocasional">Ocasional</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filtroCalculo">
                                    <option value="">Todos os c√°lculos</option>
                                    <option value="fixo">Fixo</option>
                                    <option value="percentual">Percentual</option>
                                    <option value="por_categoria">Por Categoria</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                                    <i class="bi bi-arrow-clockwise"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid de Subs√≠dios -->
                <div id="subsidiosGrid" class="row g-4">
                    <!-- Carregado via JavaScript -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Criar/Editar Subs√≠dio -->
    <div class="modal fade" id="modalSubsidio" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSubsidioTitle">
                        <i class="bi bi-wallet2"></i> Novo Subs√≠dio
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSubsidio">
                        <input type="hidden" id="subsidioId">
                        
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Nome do Subs√≠dio *</label>
                                <input type="text" class="form-control" id="subsidioNome" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tipo *</label>
                                <select class="form-select" id="subsidioTipoSubsidio" required>
                                    <option value="regular">Regular</option>
                                    <option value="especial">Especial</option>
                                    <option value="anual">Anual</option>
                                    <option value="ocasional">Ocasional</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" id="subsidioDescricao" rows="2"></textarea>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Tipo de C√°lculo *</label>
                                <select class="form-select" id="subsidioTipoCalculo" required onchange="toggleTipoCalculo()">
                                    <option value="fixo">Valor Fixo</option>
                                    <option value="percentual">Percentual do Sal√°rio</option>
                                    <option value="por_categoria">Por Categoria</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3" id="divValorPadrao">
                                <label class="form-label">Valor Padr√£o (KZ)</label>
                                <input type="number" class="form-control" id="subsidioValorPadrao" step="0.01">
                            </div>
                            
                            <div class="col-md-3" id="divPercentual" style="display:none;">
                                <label class="form-label">Percentual (%)</label>
                                <input type="number" class="form-control" id="subsidioPercentual" step="0.01">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Limite Isen√ß√£o Fiscal (KZ)</label>
                                <input type="number" class="form-control" id="subsidioLimiteIsencao" step="0.01" value="0">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Meses de Pagamento</label>
                                <select class="form-select" id="subsidioMeses" multiple size="5">
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                                <small class="text-muted">Segure Ctrl para selecionar m√∫ltiplos</small>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Parcelas</label>
                                <input type="number" class="form-control" id="subsidioParcelas" value="1" min="1">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Aplicar a</label>
                                <select class="form-select" id="subsidioAplicarA">
                                    <option value="todos">Todos</option>
                                    <option value="categoria_especifica">Categoria Espec√≠fica</option>
                                    <option value="individual">Individual</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <h6 class="mb-3 text-primary">
                                    <i class="bi bi-shield-check"></i> Tributa√ß√£o e Descontos
                                </h6>
                                <div class="alert alert-info py-2 mb-3">
                                    <small>
                                        <strong>Incide INSS:</strong> Se marcado, este subs√≠dio entra na base de c√°lculo da Seguran√ßa Social (3% empregado + 8% empresa).<br>
                                        <strong>Incide IRT:</strong> Se marcado, este subs√≠dio √© tribut√°vel para IRT. Use o limite de isen√ß√£o para definir a parte isenta.
                                    </small>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="subsidioIncideINSS" checked>
                                    <label class="form-check-label">
                                        <strong>Incide INSS (Seguran√ßa Social)</strong>
                                        <small class="d-block text-muted">Subs√≠dio sujeito a desconto de 3% para INSS</small>
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="subsidioIncideIRT" checked>
                                    <label class="form-check-label">
                                        <strong>Incide IRT (Imposto sobre Rendimento)</strong>
                                        <small class="d-block text-muted">Subs√≠dio tribut√°vel (pode ter parte isenta at√© o limite definido acima)</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarSubsidio()">
                        <i class="bi bi-check-circle"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Atribuir Subs√≠dio -->
    <div class="modal fade" id="modalAtribuir" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalAtribuicaoTitle">Atribuir Subs√≠dio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Selecionar Funcion√°rio</label>
                            <select id="selectFuncionarioAtribuir" class="form-select"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Valor Espec√≠fico (KZ)</label>
                            <input type="number" id="inputValorEspecifico" class="form-control" step="0.01" placeholder="Opcional">
                        </div>
                    </div>

                    <div>
                        <h6 class="d-flex justify-content-between align-items-center">
                            <span>Funcion√°rios com este subs√≠dio</span>
                            <span id="totalAtribuidos" class="badge bg-secondary">0</span>
                        </h6>
                        <div id="listaAtribuicoes" class="mt-2">
                            <!-- carregado via JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarAtribuicao()">Atribuir</button>
                </div>
            </div>
        </div>
    </div>

    <script src="vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        let subsidios = [];
        let editandoId = null;

        // Helper para fetch com autentica√ß√£o
        async function fetchAuth(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    ...options.headers
                }
            };
            return fetch(url, { ...options, ...defaultOptions });
        }

        // Carregar subs√≠dios
        async function carregarSubsidios() {
            try {
                const response = await fetchAuth(`${API_URL}/subsidios`);
                const data = await response.json();
                subsidios = data.data || [];
                renderizarSubsidios();
                
                // Carregar contagem de atribui√ß√µes para cada subs√≠dio
                for (const s of subsidios) {
                    try {
                        const resp = await fetchAuth(`${API_URL}/subsidios/atribuicoes/${s.id}`);
                        const atrib = await resp.json();
                        const badge = document.getElementById(`badge-atrib-${s.id}`);
                        if (badge) {
                            if (atrib.aplicar_a === 'todos') {
                                // Para subs√≠dios "para todos", mostra o total de funcion√°rios
                                badge.innerHTML = `<i class="bi bi-people-fill"></i> ${atrib.total || 0} (Todos)`;
                                badge.className = 'badge bg-success';
                            } else {
                                badge.innerHTML = `<i class="bi bi-people"></i> ${atrib.total || 0}`;
                                badge.className = 'badge bg-info';
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao carregar atribui√ß√µes:', e);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar subs√≠dios:', error);
                alert('Erro ao carregar subs√≠dios');
            }
        }

        // Renderizar grid
        function renderizarSubsidios() {
            const grid = document.getElementById('subsidiosGrid');
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroTipo = document.getElementById('filtroTipo').value;
            const filtroCalculo = document.getElementById('filtroCalculo').value;

            const subsidiosFiltrados = subsidios.filter(s => {
                const matchNome = !filtroNome || s.nome.toLowerCase().includes(filtroNome);
                const matchTipo = !filtroTipo || s.tipo_subsidio === filtroTipo;
                const matchCalculo = !filtroCalculo || s.tipo_calculo === filtroCalculo;
                return matchNome && matchTipo && matchCalculo;
            });

            grid.innerHTML = subsidiosFiltrados.map(s => `
                <div class="col-md-4">
                    <div class="card subsidio-card ${s.tipo_subsidio === 'isento' ? 'isento' : 'tributavel'} h-100 shadow-sm" data-subsidio-id="${s.id}">
                        <div class="card-body card-body-clickable">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-wallet2 text-primary"></i> ${s.nome}
                                </h5>
                                <span class="badge badge-tipo bg-${getTipoCor(s.tipo_subsidio)}">${getTipoLabel(s.tipo_subsidio)}</span>
                            </div>
                            
                            <p class="text-muted small mb-3">${s.descricao || 'Sem descri√ß√£o'}</p>
                            
                            <div class="mb-2">
                                <strong>C√°lculo:</strong> 
                                <span class="badge bg-info">${getCalculoLabel(s.tipo_calculo)}</span>
                            </div>
                            
                            ${s.tipo_calculo === 'fixo' ? `
                                <div class="mb-2">
                                    <strong>Valor:</strong> ${formatMoney(s.valor_padrao_empresa)} KZ
                                </div>
                            ` : ''}
                            
                            ${s.tipo_calculo === 'percentual' ? `
                                <div class="mb-2">
                                    <strong>Percentual:</strong> ${s.percentual}%
                                </div>
                            ` : ''}
                            
                            <div class="mb-2">
                                <strong>Limite Isen√ß√£o:</strong> ${formatMoney(s.limite_isencao_fiscal)} KZ
                            </div>
                            
                            <div class="mb-2">
                                <i class="bi bi-calendar3"></i> 
                                <small>${s.parcelas > 1 ? `${s.parcelas} parcelas` : 'Pagamento √∫nico'}</small>
                            </div>
                            
                            <div class="mt-3 d-flex gap-2">
                                <span class="badge ${s.incide_inss ? 'bg-success' : 'bg-secondary'}">
                                    ${s.incide_inss ? '‚úì' : '‚úó'} INSS
                                </span>
                                <span class="badge ${s.incide_irt ? 'bg-success' : 'bg-secondary'}">
                                    ${s.incide_irt ? '‚úì' : '‚úó'} IRT
                                </span>
                                <span class="badge ${s.aplicar_a === 'todos' ? 'bg-success' : 'bg-info'}" id="badge-atrib-${s.id}">
                                    <i class="bi bi-people"></i> ${s.aplicar_a === 'todos' ? 'Todos' : '0'}
                                </span>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between">
                                ${s.aplicar_a === 'todos' ? `
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Aplicado a todos
                                    </span>
                                ` : `
                                    <button class="btn btn-sm btn-outline-primary btn-atribuir" data-subsidio-id="${s.id}">
                                        <i class="bi bi-person-plus"></i> Atribuir ${s.aplicar_a === 'categoria_especifica' ? 'Categoria' : 'Individual'}
                                    </button>
                                `}
                                <button class="btn btn-sm btn-outline-danger btn-eliminar" data-subsidio-id="${s.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Helpers
        function getTipoCor(tipo) {
            const cores = {
                regular: 'primary',
                especial: 'warning',
                anual: 'success',
                ocasional: 'info'
            };
            return cores[tipo] || 'secondary';
        }

        function getTipoLabel(tipo) {
            const labels = {
                regular: 'Regular',
                especial: 'Especial',
                anual: 'Anual',
                ocasional: 'Ocasional'
            };
            return labels[tipo] || tipo;
        }

        function getCalculoLabel(tipo) {
            const labels = {
                fixo: 'Valor Fixo',
                percentual: 'Percentual',
                por_categoria: 'Por Categoria'
            };
            return labels[tipo] || tipo;
        }

        function formatMoney(value) {
            return new Intl.NumberFormat('pt-AO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value || 0);
        }

        function toggleTipoCalculo() {
            const tipo = document.getElementById('subsidioTipoCalculo').value;
            const limiteIsencaoInput = document.getElementById('subsidioLimiteIsencao');
            
            document.getElementById('divValorPadrao').style.display = tipo === 'fixo' ? 'block' : 'none';
            document.getElementById('divPercentual').style.display = tipo === 'percentual' ? 'block' : 'none';
            
            // Bloquear isen√ß√£o para subs√≠dios percentuais
            if (tipo === 'percentual') {
                limiteIsencaoInput.value = 0;
                limiteIsencaoInput.disabled = true;
                limiteIsencaoInput.parentElement.title = 'Subs√≠dios percentuais n√£o podem ter isen√ß√£o fiscal';
            } else {
                limiteIsencaoInput.disabled = false;
                limiteIsencaoInput.parentElement.title = '';
            }
        }

        function limparFiltros() {
            document.getElementById('filtroNome').value = '';
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroCalculo').value = '';
            renderizarSubsidios();
        }

        async function salvarSubsidio() {
            const mesesSelecionados = Array.from(document.getElementById('subsidioMeses').selectedOptions)
                .map(opt => opt.value).join(',') || '1,2,3,4,5,6,7,8,9,10,11,12';

            const dados = {
                nome: document.getElementById('subsidioNome').value,
                descricao: document.getElementById('subsidioDescricao').value,
                tipo_calculo: document.getElementById('subsidioTipoCalculo').value,
                tipo_subsidio: document.getElementById('subsidioTipoSubsidio').value,
                valor_padrao_empresa: parseFloat(document.getElementById('subsidioValorPadrao').value) || 0,
                percentual: parseFloat(document.getElementById('subsidioPercentual').value) || 0,
                limite_isencao_fiscal: parseFloat(document.getElementById('subsidioLimiteIsencao').value) || 0,
                meses_pagamento: mesesSelecionados,
                parcelas: parseInt(document.getElementById('subsidioParcelas').value) || 1,
                aplicar_a: document.getElementById('subsidioAplicarA').value,
                incide_inss: document.getElementById('subsidioIncideINSS').checked ? 1 : 0,
                incide_irt: document.getElementById('subsidioIncideIRT').checked ? 1 : 0
            };

            try {
                const url = editandoId ? `${API_URL}/subsidios/${editandoId}` : `${API_URL}/subsidios`;
                const method = editandoId ? 'PUT' : 'POST';

                const response = await fetchAuth(url, {
                    method,
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalSubsidio')).hide();
                    await carregarSubsidios();
                    document.getElementById('formSubsidio').reset();
                    editandoId = null;
                } else {
                    alert('Erro ao salvar subs√≠dio');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar subs√≠dio');
            }
        }

        function editarSubsidio(id) {
            const subsidio = subsidios.find(s => s.id === id);
            if (!subsidio) return;

            editandoId = id;
            document.getElementById('modalSubsidioTitle').innerHTML = '<i class="bi bi-pencil"></i> Editar Subs√≠dio';
            document.getElementById('subsidioId').value = subsidio.id;
            document.getElementById('subsidioNome').value = subsidio.nome;
            document.getElementById('subsidioDescricao').value = subsidio.descricao || '';
            document.getElementById('subsidioTipoCalculo').value = subsidio.tipo_calculo;
            document.getElementById('subsidioTipoSubsidio').value = subsidio.tipo_subsidio;
            document.getElementById('subsidioValorPadrao').value = subsidio.valor_padrao_empresa;
            document.getElementById('subsidioPercentual').value = subsidio.percentual;
            document.getElementById('subsidioLimiteIsencao').value = subsidio.limite_isencao_fiscal;
            document.getElementById('subsidioParcelas').value = subsidio.parcelas;
            document.getElementById('subsidioAplicarA').value = subsidio.aplicar_a;
            document.getElementById('subsidioIncideINSS').checked = subsidio.incide_inss;
            document.getElementById('subsidioIncideIRT').checked = subsidio.incide_irt;

            const meses = subsidio.meses_pagamento.split(',');
            Array.from(document.getElementById('subsidioMeses').options).forEach(opt => {
                opt.selected = meses.includes(opt.value);
            });

            toggleTipoCalculo();
            new bootstrap.Modal(document.getElementById('modalSubsidio')).show();
        }

        async function eliminarSubsidio(id) {
            if (!confirm('Tem certeza que deseja eliminar este subs√≠dio?')) return;

            try {
                const response = await fetchAuth(`${API_URL}/subsidios/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await carregarSubsidios();
                } else {
                    alert('Erro ao eliminar subs√≠dio');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao eliminar subs√≠dio');
            }
        }

        function atribuirSubsidio(id) {
            abrirModalAtribuicao(id);
        }

        // ----- Modal de Atribui√ß√£o de Subs√≠dio -----
        let currentSubsidioId = null;

        async function abrirModalAtribuicao(subsidioId) {
            currentSubsidioId = subsidioId;
            // Carregar subs√≠dio para t√≠tulo
            const s = subsidios.find(x => x.id === subsidioId) || { nome: 'Subs√≠dio' };
            document.getElementById('modalAtribuicaoTitle').textContent = `Atribuir: ${s.nome}`;

            // Carregar funcion√°rios para select
            try {
                const resp = await fetchAuth(`${API_URL}/funcionarios`);
                const data = await resp.json();
                
                console.log('üìã Response funcion√°rios:', data);
                
                const funcs = data.data || [];
                const select = document.getElementById('selectFuncionarioAtribuir');
                select.innerHTML = '<option value="">Selecione um funcion√°rio...</option>' +
                    funcs.filter(f => f.ativo).map(f => `<option value="${f.id}">${f.nome} ‚Äî ${formatMoney(f.salario_base)} KZ</option>`).join('');

                // Carregar atribui√ß√µes existentes para este subs√≠dio
                await carregarAtribuicoes(subsidioId);

                new bootstrap.Modal(document.getElementById('modalAtribuir')).show();
            } catch (error) {
                console.error('Erro ao abrir modal de atribui√ß√£o:', error);
                alert('Erro ao carregar funcion√°rios');
            }
        }

        async function carregarAtribuicoes(subsidioId) {
            try {
                const resp = await fetchAuth(`${API_URL}/subsidios/atribuicoes/${subsidioId}`);
                const data = await resp.json();
                const list = document.getElementById('listaAtribuicoes');
                document.getElementById('totalAtribuidos').textContent = data.total || 0;
                
                if (!data.data || data.data.length === 0) {
                    list.innerHTML = '<div class="text-muted text-center py-3">Nenhuma atribui√ß√£o</div>';
                    return;
                }

                list.innerHTML = data.data.map(a => `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <strong>${a.nome}</strong><br>
                            <small class="text-muted">Sal√°rio base: ${formatMoney(a.salario_base)} KZ</small>
                        </div>
                        <div class="text-end">
                            <div>Valor espec√≠fico: <strong>${a.valor_especifico ? formatMoney(a.valor_especifico) + ' KZ' : '-'}</strong></div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-danger" onclick="removerAtribuicao(${a.funcionario_id}, ${subsidioId})">
                                    <i class="bi bi-trash"></i> Remover
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar atribui√ß√µes:', error);
                document.getElementById('listaAtribuicoes').innerHTML = '<div class="text-danger">Erro ao carregar</div>';
            }
        }

        async function confirmarAtribuicao() {
            const funcionarioId = document.getElementById('selectFuncionarioAtribuir').value;
            const valorEspecifico = parseFloat(document.getElementById('inputValorEspecifico').value) || null;
            if (!funcionarioId) { alert('Selecione um funcion√°rio'); return; }

            try {
                const resp = await fetchAuth(`${API_URL}/subsidios/atribuir`, {
                    method: 'POST',
                    body: JSON.stringify({ funcionario_id: parseInt(funcionarioId), subsidio_id: currentSubsidioId, valor_especifico: valorEspecifico })
                });

                const data = await resp.json();
                if (data.success) {
                    await carregarAtribuicoes(currentSubsidioId);
                    // Optionally refresh UI
                    await carregarSubsidios();
                } else {
                    alert('Erro ao atribuir subs√≠dio');
                }
            } catch (error) {
                console.error('Erro ao atribuir:', error);
                alert('Erro ao atribuir subs√≠dio');
            }
        }

        async function removerAtribuicao(funcionarioId, subsidioId) {
            if (!confirm('Remover este subs√≠dio deste funcion√°rio?')) return;
            try {
                const resp = await fetchAuth(`${API_URL}/subsidios/atribuir/${funcionarioId}/${subsidioId}`, { method: 'DELETE' });
                const data = await resp.json();
                if (data.success) {
                    await carregarAtribuicoes(subsidioId);
                    await carregarSubsidios();
                } else {
                    alert('Erro ao remover atribui√ß√£o');
                }
            } catch (error) {
                console.error('Erro ao remover atribui√ß√£o:', error);
                alert('Erro ao remover atribui√ß√£o');
            }
        }

        // Event listeners
        document.getElementById('filtroNome').addEventListener('input', renderizarSubsidios);
        document.getElementById('filtroTipo').addEventListener('change', renderizarSubsidios);
        document.getElementById('filtroCalculo').addEventListener('change', renderizarSubsidios);

        // Event delegation no container (permanece no DOM)
        const gridElement = document.getElementById('subsidiosGrid');
        
        gridElement.addEventListener('click', (e) => {
            // Bot√£o Atribuir
            const btnAtribuir = e.target.closest('.btn-atribuir');
            if (btnAtribuir) {
                e.preventDefault();
                e.stopPropagation();
                const id = parseInt(btnAtribuir.dataset.subsidioId);
                atribuirSubsidio(id);
                return;
            }
            
            // Bot√£o Eliminar
            const btnEliminar = e.target.closest('.btn-eliminar');
            if (btnEliminar) {
                e.preventDefault();
                e.stopPropagation();
                const id = parseInt(btnEliminar.dataset.subsidioId);
                eliminarSubsidio(id);
                return;
            }
            
            // Ignorar se clicou em qualquer bot√£o
            if (e.target.closest('button')) {
                return;
            }
            
            // Card body para editar (s√≥ se n√£o for bot√£o)
            const cardBody = e.target.closest('.card-body-clickable');
            if (cardBody) {
                const card = cardBody.closest('.card');
                const id = parseInt(card.dataset.subsidioId);
                editarSubsidio(id);
                return;
            }
        });

        document.getElementById('modalSubsidio').addEventListener('hide.bs.modal', () => {
            document.getElementById('btnNovoSubsidio')?.focus();
        });

        document.getElementById('modalSubsidio').addEventListener('hidden.bs.modal', () => {
            document.getElementById('formSubsidio').reset();
            document.getElementById('modalSubsidioTitle').innerHTML = '<i class="bi bi-wallet2"></i> Novo Subs√≠dio';
            editandoId = null;
        });

        document.getElementById('modalAtribuir').addEventListener('hide.bs.modal', () => {
            document.getElementById('btnNovoSubsidio')?.focus();
        });

        // Inicializar
        carregarSubsidios();
    </script>
    <script src="js/folha-footer.js"></script>
</body>
</html>
