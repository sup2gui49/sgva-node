<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Integra√ß√£o Folha-Vendas - SGVA</title>
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="vendor/bootstrap-icons/bootstrap-icons.css">
    <style>
        body {
            background: #f4f6f9;
            padding: 2rem;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-success {
            border-left: 4px solid #27ae60;
        }
        .test-error {
            border-left: 4px solid #e74c3c;
        }
        .test-warning {
            border-left: 4px solid #f39c12;
        }
        .test-info {
            border-left: 4px solid #3498db;
        }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        .badge-lg {
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <div class="text-center mb-4">
                    <h1><i class="bi bi-clipboard-check"></i> Teste de Integra√ß√£o Folha-Vendas</h1>
                    <p class="text-muted">Valida√ß√£o completa da integra√ß√£o entre sistemas</p>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>Testes</h5>
                                <h2 id="totalTestes" class="text-primary">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>Sucesso</h5>
                                <h2 id="totalSucesso" class="text-success">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>Avisos</h5>
                                <h2 id="totalAvisos" class="text-warning">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>Erros</h5>
                                <h2 id="totalErros" class="text-danger">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-primary btn-lg" onclick="executarTestes()">
                        <i class="bi bi-play-circle"></i> Executar Todos os Testes
                    </button>
                </div>

                <div id="resultados"></div>

                <div class="text-center mt-4">
                    <a href="index.html" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
                    </a>
                    <a href="folha-calculo.html" class="btn btn-primary">
                        <i class="bi bi-calculator"></i> Ir para Folha de Pagamento
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '/api';
        let totalTestes = 0;
        let totalSucesso = 0;
        let totalAvisos = 0;
        let totalErros = 0;

        async function executarTestes() {
            limparResultados();
            
            await teste1_VerificarEndpoints();
            await teste2_VerificarFuncionarios();
            await teste3_VerificarFolhasCalculadas();
            await teste4_VerificarDespesas();
            await teste5_VerificarDRE();
            await teste6_ValidarIntegracao();
            
            atualizarContadores();
        }

        async function teste1_VerificarEndpoints() {
            const resultado = { titulo: 'Teste 1: Verificar Endpoints da API' };
            
            try {
                // Testar endpoint de folha
                const resFolha = await fetch(`${API_URL}/folha-profissional/calcular-completa`, {
                    method: 'OPTIONS'
                });
                resultado.folhaEndpoint = resFolha.status !== 404;

                // Testar endpoint de confirma√ß√£o
                const resConfirmar = await fetch(`${API_URL}/folha/confirmar-pagamento`, {
                    method: 'OPTIONS'
                });
                resultado.confirmarEndpoint = resConfirmar.status !== 404;

                // Testar endpoint de DRE
                const resDRE = await fetch(`${API_URL}/financeiro/dre`);
                resultado.dreEndpoint = resDRE.status === 200;
                
                const dreData = await resDRE.json();
                resultado.dreTemDespesasPessoal = dreData.dre?.despesas_pessoal !== undefined;

                if (resultado.folhaEndpoint && resultado.confirmarEndpoint && resultado.dreEndpoint && resultado.dreTemDespesasPessoal) {
                    adicionarResultado('success', resultado.titulo, `
                        ‚úÖ Endpoint /calcular-completa: OK<br>
                        ‚úÖ Endpoint /confirmar-pagamento: OK<br>
                        ‚úÖ Endpoint /dre: OK<br>
                        ‚úÖ DRE retorna despesas_pessoal: OK
                    `);
                } else {
                    adicionarResultado('error', resultado.titulo, `
                        ${resultado.folhaEndpoint ? '‚úÖ' : '‚ùå'} Endpoint /calcular-completa<br>
                        ${resultado.confirmarEndpoint ? '‚úÖ' : '‚ùå'} Endpoint /confirmar-pagamento<br>
                        ${resultado.dreEndpoint ? '‚úÖ' : '‚ùå'} Endpoint /dre<br>
                        ${resultado.dreTemDespesasPessoal ? '‚úÖ' : '‚ùå'} DRE retorna despesas_pessoal
                    `);
                }
            } catch (error) {
                adicionarResultado('error', resultado.titulo, `‚ùå Erro: ${error.message}`);
            }
        }

        async function teste2_VerificarFuncionarios() {
            const resultado = { titulo: 'Teste 2: Verificar Funcion√°rios Ativos' };
            
            try {
                const response = await fetch(`${API_URL}/funcionarios`);
                const data = await response.json();
                
                const funcionariosAtivos = data.data.filter(f => f.ativo);
                resultado.total = funcionariosAtivos.length;
                resultado.comSalario = funcionariosAtivos.filter(f => f.salario_base > 0).length;

                if (resultado.total > 0 && resultado.comSalario === resultado.total) {
                    adicionarResultado('success', resultado.titulo, `
                        ‚úÖ ${resultado.total} funcion√°rio(s) ativo(s)<br>
                        ‚úÖ Todos t√™m sal√°rio base definido
                    `);
                } else if (resultado.total === 0) {
                    adicionarResultado('error', resultado.titulo, `
                        ‚ùå Nenhum funcion√°rio ativo encontrado<br>
                        üí° Cadastre funcion√°rios em: <a href="folha-funcionarios.html">Gest√£o de Funcion√°rios</a>
                    `);
                } else {
                    adicionarResultado('warning', resultado.titulo, `
                        ‚ö†Ô∏è ${resultado.total} funcion√°rio(s) ativo(s)<br>
                        ‚ö†Ô∏è ${resultado.total - resultado.comSalario} sem sal√°rio base definido
                    `);
                }
            } catch (error) {
                adicionarResultado('error', resultado.titulo, `‚ùå Erro: ${error.message}`);
            }
        }

        async function teste3_VerificarFolhasCalculadas() {
            const resultado = { titulo: 'Teste 3: Verificar Folhas Calculadas' };
            
            try {
                // Simular busca de folhas (n√£o temos endpoint direto, mas podemos inferir do DRE)
                const response = await fetch(`${API_URL}/financeiro/dre`);
                const data = await response.json();
                
                const despesasPessoal = data.dre.despesas_pessoal;
                const temFolhaRegistrada = despesasPessoal?.detalhamento?.folha_registrada;
                const totalFuncionarios = despesasPessoal?.detalhamento?.total_funcionarios || 0;

                if (temFolhaRegistrada) {
                    adicionarResultado('success', resultado.titulo, `
                        ‚úÖ Folha registrada para o m√™s atual<br>
                        ‚úÖ ${totalFuncionarios} funcion√°rio(s) na folha<br>
                        ‚úÖ Sal√°rio Base: ${despesasPessoal.detalhamento.salario_base_total} KZ<br>
                        ‚úÖ Sal√°rio L√≠quido: ${despesasPessoal.salarios_liquidos} KZ<br>
                        ‚úÖ INSS Patronal: ${despesasPessoal.inss_patronal} KZ
                    `);
                } else {
                    adicionarResultado('warning', resultado.titulo, `
                        ‚ö†Ô∏è Nenhuma folha confirmada para o m√™s atual<br>
                        üí° Para registrar: <a href="folha-calculo.html">Calcular Folha</a> ‚Üí Calcular Todos ‚Üí Confirmar Pagamento
                    `);
                }
            } catch (error) {
                adicionarResultado('error', resultado.titulo, `‚ùå Erro: ${error.message}`);
            }
        }

        async function teste4_VerificarDespesas() {
            const resultado = { titulo: 'Teste 4: Verificar Despesas Registradas' };
            
            try {
                const response = await fetch(`${API_URL}/financeiro/dre`);
                const data = await response.json();
                
                const despesasPessoal = data.dre.despesas_pessoal;
                const salarios = parseFloat(despesasPessoal?.salarios_liquidos || 0);
                const inss = parseFloat(despesasPessoal?.inss_patronal || 0);
                const total = parseFloat(despesasPessoal?.total_custo_pessoal || 0);

                if (salarios > 0) {
                    adicionarResultado('success', resultado.titulo, `
                        ‚úÖ Despesas de sal√°rios: ${formatMoney(salarios)} KZ<br>
                        ‚úÖ Despesas de INSS Patronal: ${formatMoney(inss)} KZ<br>
                        ‚úÖ Total custo com pessoal: ${formatMoney(total)} KZ
                    `);
                } else {
                    adicionarResultado('warning', resultado.titulo, `
                        ‚ö†Ô∏è Nenhuma despesa de sal√°rios registrada<br>
                        üí° Calcule e confirme uma folha para registrar despesas
                    `);
                }
            } catch (error) {
                adicionarResultado('error', resultado.titulo, `‚ùå Erro: ${error.message}`);
            }
        }

        async function teste5_VerificarDRE() {
            const resultado = { titulo: 'Teste 5: Verificar DRE' };
            
            try {
                const response = await fetch(`${API_URL}/financeiro/dre`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('DRE retornou erro');
                }

                const dre = data.dre;
                const temReceitas = parseFloat(dre.receita_bruta_com_iva) > 0;
                const temDespesasPessoal = dre.despesas_pessoal !== undefined;
                const temLucro = dre.lucro_liquido !== undefined;

                if (temDespesasPessoal && temLucro) {
                    adicionarResultado('success', resultado.titulo, `
                        ‚úÖ DRE calculado corretamente<br>
                        ‚úÖ Receita Bruta: ${dre.receita_bruta_com_iva} KZ<br>
                        ‚úÖ Despesas Pessoal: ${dre.despesas_pessoal.total_custo_pessoal} KZ<br>
                        ‚úÖ Lucro L√≠quido: ${dre.lucro_liquido} KZ<br>
                        ${temReceitas ? '‚úÖ Sistema tem receitas registradas' : '‚ö†Ô∏è Nenhuma receita registrada'}
                    `);
                } else {
                    adicionarResultado('error', resultado.titulo, `
                        ‚ùå DRE n√£o est√° completo<br>
                        ${temDespesasPessoal ? '‚úÖ' : '‚ùå'} Despesas com pessoal<br>
                        ${temLucro ? '‚úÖ' : '‚ùå'} Lucro l√≠quido
                    `);
                }
            } catch (error) {
                adicionarResultado('error', resultado.titulo, `‚ùå Erro: ${error.message}`);
            }
        }

        async function teste6_ValidarIntegracao() {
            const resultado = { titulo: 'Teste 6: Validar Integra√ß√£o Completa' };
            
            try {
                const response = await fetch(`${API_URL}/financeiro/dre`);
                const data = await response.json();
                
                const despesasPessoal = data.dre.despesas_pessoal;
                const temFolhaRegistrada = despesasPessoal?.detalhamento?.folha_registrada;
                const salarios = parseFloat(despesasPessoal?.salarios_liquidos || 0);
                const inss = parseFloat(despesasPessoal?.inss_patronal || 0);
                const totalFuncionarios = despesasPessoal?.detalhamento?.total_funcionarios || 0;

                if (temFolhaRegistrada && salarios > 0 && inss > 0 && totalFuncionarios > 0) {
                    adicionarResultado('success', resultado.titulo, `
                        ‚úÖ INTEGRA√á√ÉO FUNCIONANDO PERFEITAMENTE!<br><br>
                        <strong>Resumo:</strong><br>
                        ‚Ä¢ ${totalFuncionarios} funcion√°rio(s) com folha calculada<br>
                        ‚Ä¢ Sal√°rios registrados como despesas: ${formatMoney(salarios)} KZ<br>
                        ‚Ä¢ INSS Patronal registrado: ${formatMoney(inss)} KZ<br>
                        ‚Ä¢ DRE mostra valores REAIS (n√£o estimados)<br>
                        ‚Ä¢ Sistema est√° pronto para uso em produ√ß√£o
                    `);
                } else if (temFolhaRegistrada && salarios > 0) {
                    adicionarResultado('warning', resultado.titulo, `
                        ‚ö†Ô∏è INTEGRA√á√ÉO PARCIAL<br><br>
                        <strong>Status:</strong><br>
                        ${salarios > 0 ? '‚úÖ' : '‚ùå'} Sal√°rios registrados<br>
                        ${inss > 0 ? '‚úÖ' : '‚ö†Ô∏è'} INSS Patronal ${inss > 0 ? 'registrado' : 'n√£o registrado'}<br>
                        ${totalFuncionarios > 0 ? '‚úÖ' : '‚ùå'} Funcion√°rios na folha<br><br>
                        üí° Recomenda√ß√£o: Recalcule e confirme a folha novamente
                    `);
                } else {
                    adicionarResultado('info', resultado.titulo, `
                        ‚ÑπÔ∏è INTEGRA√á√ÉO PRONTA MAS N√ÉO UTILIZADA<br><br>
                        <strong>Para ativar a integra√ß√£o:</strong><br>
                        1. Acesse <a href="folha-calculo.html">Folha de Pagamento</a><br>
                        2. Selecione o m√™s e ano<br>
                        3. Clique em "Calcular Todos"<br>
                        4. Clique em "Confirmar Pagamento e Registrar nas Despesas"<br>
                        5. Verifique o DRE com valores reais<br><br>
                        <strong>Sistema pronto para uso!</strong>
                    `);
                }
            } catch (error) {
                adicionarResultado('error', resultado.titulo, `‚ùå Erro: ${error.message}`);
            }
        }

        function adicionarResultado(tipo, titulo, conteudo) {
            totalTestes++;
            if (tipo === 'success') totalSucesso++;
            else if (tipo === 'warning') totalAvisos++;
            else if (tipo === 'error') totalErros++;

            const tipoClass = {
                'success': 'test-success',
                'error': 'test-error',
                'warning': 'test-warning',
                'info': 'test-info'
            }[tipo];

            const icone = {
                'success': 'bi-check-circle-fill text-success',
                'error': 'bi-x-circle-fill text-danger',
                'warning': 'bi-exclamation-triangle-fill text-warning',
                'info': 'bi-info-circle-fill text-primary'
            }[tipo];

            const html = `
                <div class="test-card ${tipoClass}">
                    <h5><i class="bi ${icone}"></i> ${titulo}</h5>
                    <div class="mt-2">${conteudo}</div>
                </div>
            `;

            document.getElementById('resultados').innerHTML += html;
        }

        function atualizarContadores() {
            document.getElementById('totalTestes').textContent = totalTestes;
            document.getElementById('totalSucesso').textContent = totalSucesso;
            document.getElementById('totalAvisos').textContent = totalAvisos;
            document.getElementById('totalErros').textContent = totalErros;
        }

        function limparResultados() {
            document.getElementById('resultados').innerHTML = '';
            totalTestes = 0;
            totalSucesso = 0;
            totalAvisos = 0;
            totalErros = 0;
            atualizarContadores();
        }

        function formatMoney(value) {
            const numero = Number(value);
            return new Intl.NumberFormat('pt-AO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(Number.isFinite(numero) ? numero : 0);
        }

        // Executar automaticamente ao carregar
        window.addEventListener('load', () => {
            executarTestes();
        });
    </script>
</body>
</html>
